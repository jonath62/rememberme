import os
import sys
import google.genai as genai
from github import Github, GithubException
import re

def get_file_path_from_issue(issue_body):
    match = re.search(r"`([^`]+)`", issue_body)
    if match:
        return match.group(1)
    return None

def check_environment_variables():
    """Checks for all required environment variables and exits with a specific error if any are missing."""
    required_vars = {
        "GEMINI_API_KEY": "Error: The GEMINI_API_KEY is missing. Please add it as a secret in your repository's 'Settings > Secrets and variables > Actions' page.",
        "GITHUB_TOKEN": "Error: The GITHUB_TOKEN is missing. This should be automatically provided by GitHub Actions.",
        "GITHUB_REPOSITORY": "Error: The GITHUB_REPOSITORY is missing. This should be automatically provided by GitHub Actions.",
        "ISSUE_NUMBER": "Error: The ISSUE_NUMBER is missing. This script must be triggered from a GitHub issue."
    }
    for var, error_message in required_vars.items():
        if not os.getenv(var):
            print(error_message)
            sys.exit(1)
    return {var: os.getenv(var) for var in required_vars}

def main():
    # --- Check Environment & Get Credentials --- #
    env_vars = check_environment_variables()
    gemini_api_key = env_vars["GEMINI_API_KEY"]
    github_token = env_vars["GITHUB_TOKEN"]
    repo_name = env_vars["GITHUB_REPOSITORY"]
    issue_number = int(env_vars["ISSUE_NUMBER"])

    # --- Authenticate & Get Repo/Issue --- #
    genai.configure(api_key=gemini_api_key)
    g = Github(github_token)
    try:
        repo = g.get_repo(repo_name)
        issue = repo.get_issue(number=issue_number)
    except GithubException as e:
        print(f"Error accessing GitHub: {e}")
        sys.exit(1)

    # --- AI Task (Generate new content) --- #
    file_path = get_file_path_from_issue(issue.body)
    if not file_path:
        issue.create_comment("Could not determine the file to modify from the issue body. Please specify the file in the format: `path/to/your/file.ext`")
        sys.exit(1)

    try:
        file_content_obj = repo.get_contents(file_path)
        file_content = file_content_obj.decoded_content.decode()
    except GithubException:
        issue.create_comment(f"Error: The file `{file_path}` could not be found in the repository.")
        sys.exit(1)

    model = genai.GenerativeModel('gemini-pro')
    prompt = f"""Here is the content of the file `{file_path}`:

```
{file_content}
```

Please apply the following changes as described in the issue: '{issue.title}' - '{issue.body}'.

Your response should ONLY be the complete, updated code for the file `{file_path}`. Do not include any other text, markdown, or explanations.
"""

    try:
        response = model.generate_content(prompt)
        new_content = response.text
    except Exception as e:
        issue.create_comment(f"Error generating code with the AI model: {e}")
        sys.exit(1)

    # --- Git Operations --- #
    new_branch_name = f"ai-changes-{issue.number}"
    source_branch_name = "main"

    try:
        source_branch = repo.get_branch(source_branch_name)

        try:
            ref = repo.get_git_ref(f"heads/{new_branch_name}")
            ref.delete()
        except GithubException:
            pass # Branch doesn't exist, which is fine.

        repo.create_git_ref(ref=f"refs/heads/{new_branch_name}", sha=source_branch.commit.sha)

        repo.update_file(
            path=file_path,
            message=f"feat: Apply AI changes for issue #{issue.number}",
            content=new_content,
            branch=new_branch_name,
            sha=file_content_obj.sha
        )

        pr = repo.create_pull(
            title=f"AI-Generated Fix for: {issue.title}",
            body=f"This pull request was automatically generated by an AI agent in response to issue #{issue.number}. Please review the changes before merging.",
            head=new_branch_name,
            base=source_branch_name
        )

        issue.create_comment(f"I have created a pull request with the requested changes. You can find it here: {pr.html_url}")

    except GithubException as e:
        issue.create_comment(f"An error occurred during the Git operations: {e.data.get('message', str(e))}")
        sys.exit(1)
    except Exception as e:
        issue.create_comment(f"An unexpected error occurred: {str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    main()
